Create database Project_Retail
--Data preperation and understanding
-- What is the total number of rows in each of the 3 tables in the database?

select count(*) AS total_rows
from [dbo].[Customer]
union
select count(*) AS total_rows
from [dbo].[prod_cat_info]
union
select count(*) AS total_rows
from [dbo].Transactions

--What is the total number of transactions that have a return?
select COUNT(distinct(transaction_id)) AS return_count
from Transactions
where Qty<0

--As you would have noticed, the dates provided across the datasets are not in correct format. As first steps, please convert the date variables into valid date format before proceeding ahead.
select CONVERT(date, tran_date,105) as new_dates
from Transactions
EXEC sp_help 'Transactions'

--What is the time range of the transaction data available for analysis? Show the output in number of days, months and years simultaneously in different columns.
select 
DATEDIFF(YEAR, min(CONVERT(date, tran_date,105)), max(CONVERT(date, tran_date,105))) as TOTAL_YEAR,
DATEDIFF(MONTH, min(CONVERT(date, tran_date,105)) ,max(CONVERT(date, tran_date,105))) as TOTAL_MONTHS,
DATEDIFF(DAY,min(CONVERT(date, tran_date,105)),max(CONVERT(date, tran_date,105))) as TOTAL_DAYS
from Transactions

--Which product category does the sub-category “DIY” belong to?
select prod_cat
from prod_cat_info
WHERE prod_subcat ='DIY'

--DATA ANALYSIS
--Which channel is most frequently used for transactions?
select top 1 Store_type AS most_frequenyly_used, COUNT(*) as usage_count
from Transactions
group by Store_type
order by COUNT(*) DESC


--What is the count of Male and Female customers in the database?
select 
(select COUNT(*) from Customer where Gender ='M' )AS male_count,
(select COUNT(*) from Customer where Gender ='F')AS female_count

--From which city do we have the maximum number of customers and how many?
select top 1 count(DISTINCT customer_Id) AS CNT, city_code
from Customer
group by city_code
order by CNT DESC

--How many sub-categories are there under the Books category?
select distinct prod_subcat AS count_books, prod_cat
from prod_cat_info
group by prod_cat, prod_subcat
having prod_cat = 'Books'

--What is the maximum quantity of products ever ordered?
select  MAX(Qty) AS max_quantity_ordered, prod_cat_code
from Transactions
GROUP BY prod_cat_code

--What is the net total revenue generated in categories Electronics and Books?
select sum(cast(total_amt as float)) AS net_total_revenue, B.prod_cat
from Transactions AS A
INNER join prod_cat_info AS B
on A.prod_cat_code = B.prod_cat_code AND A.prod_subcat_code =B.prod_sub_cat_code
where prod_cat in ('Electronics' , 'Books')
group by B.prod_cat 

select *
from prod_cat_info

--How many customers have >10 transactions with us, excluding returns?
select count(*) AS customer_count
from(
	select  cust_id
	from Transactions
	where qty >0 
	group by cust_id
	having count(*)>10 )AS active_customers

--What is the combined revenue earned from the “Electronics” & “Clothing” categories, from “Flagship stores”?
select sum(total_amt) AS combined_revenue
from Transactions AS A
left join prod_cat_info AS B
on A.prod_cat_code = b.prod_cat_code
where B.prod_cat in ('Electronics' , 'Clothing') and A.Store_type ='Flagship store' 

--What is the total revenue generated from “Male” customers in “Electronics” category? Output should display total revenue by product sub-category.
select sum(T.total_amt) AS total_revenue ,T.prod_subcat_code AS sub_category
from
(
	select * 
	from Customer AS A
	right JOIN Transactions AS B
	on A.customer_Id = B.cust_id
	where Gender ='M'
) AS T
join prod_cat_info AS C
on T.prod_subcat_code = C.prod_sub_cat_code
where C.prod_cat = 'Electronics'
GROUP BY T.prod_subcat_code;



--What is percentage of sales and returns by product sub-category; display only top 5 sub-categories in terms of sales?

select top 5  
	B.prod_sub_cat_code , 
	B.prod_subcat,
	sum(case when A.qty > 0 then A.total_amt else 0 End) AS sales_amount,
	sum(case when A.qty < 0 then A.total_amt else 0 End) AS return_amount,
	Round(
		100.0*sum(case when A.qty > 0 then A.total_amt else 0 End)/
	    Nullif(sum(case when A.qty < 0 then A.total_amt else 0 End),0),2) AS return_percentage
from Transactions AS A
left join prod_cat_info AS B
ON A.prod_subcat_code = B.prod_sub_cat_code
GROUP BY B.prod_sub_cat_code, B.prod_subcat

--For all customers aged between 25 to 35 years, find what is the net total revenue generated by these consumers in the last 30 days of transactions from max transaction date available in the data?


WITH selected_cust AS (
select B.tran_date, DATEDIFF(year,DOB, GETDATE()) AS Age, B.total_amt, A.customer_Id
from Customer AS A
right join Transactions AS B
on A.customer_id = B.cust_id
where DATEDIFF(year,DOB, GETDATE()) between 25 and 35
),

date_range AS (
select max(tran_date) AS max_date, dateadd(day,-30, max(tran_date)) AS min_date
from Transactions
)

select sum(S.total_amt) AS net_revenue
from selected_cust AS S
join date_range AS D
	on S.tran_date between D.min_date and D.max_date


--Which product category has seen the max value of returns in the last 3 months of transactions?
SELECT TOP 1
B.prod_cat, sum(A.total_amt) AS total_return_value
from Transactions AS A
join prod_cat_info AS B
	on A.prod_subcat_code =B.prod_sub_cat_code
where A.qty <0
	and A.tran_date BETWEEN DATEADD(month, -3,(select max(tran_date) from transactions)) AND (select max(tran_date) from transactions)
group by B.prod_cat

--Which store-type sells the maximum products; by value of sales amount and by quantity sold?
select top 1 sum(Qty) AS products_sold, sum(total_amt) AS sales_amount, Store_type
from Transactions
where QTY > 0 
group by Store_type
order by products_sold DESC

--What are the categories for which average revenue is above the overall average?
with cat_avg AS(
select prod_cat, avg(total_amt) AS category_average, (select AVG(total_amt) FROM Transactions) AS overall_average 
from Transactions AS A
left join prod_cat_info AS B
on A.prod_cat_code = B.prod_cat_code
group by prod_cat
)

select top 1 *
from cat_avg
where category_average> overall_average
order by category_average DESC

--Find the average and total revenue by each subcategory for the categories which are among top 5 categories in terms of quantity sold.
-- Step 1: Get top 5 product categories by total quantity sold
with top_categories AS (
select top 5 A.prod_cat_code, A.Qty
from Transactions AS A
where QTY > 0
group by A.prod_cat_code, Qty
order by sum(A.qty) DESC
)

-- Step 2: Join with prod_cat_info and filter on top categories
select
B.prod_subcat,
AVG(A.total_amt) as average , SUM(A.total_amt) AS total_revenue
from transactions as A
left join prod_cat_info as B
ON A.prod_subcat_code = B.prod_sub_cat_code
WHERE A.prod_cat_code IN (SELECT prod_cat_code FROM top_categories)
GROUP BY B.prod_subcat
ORDER BY B.prod_subcat;





select *
from prod_cat_info
